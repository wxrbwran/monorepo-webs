pipeline {
    agent {
        label "YX_TEST"
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '5'))
        skipDefaultCheckout()
        disableConcurrentBuilds()
//        retry(2)
//        skipStagesAfterUnstable()
        timeout(time: 30, unit: 'MINUTES')
        timestamps()
        ansiColor('xterm')
    }

    tools {
        nodejs "NODEJS_14"
    }

    stages {
        stage('prepare') {
            steps {
                sh 'node -v'
                script {
                    if (env.BRANCH_NAME == 'master') {
                        env.NODE_ENV = "production"
                        env.APP_ENV = "prod"
                        env.MOCK = "none"
                        env.BUILD_SH = "export NODE_ENV=${env.NODE_ENV} && export APP_ENV=${env.APP_ENV} && npx umi build"
                        env.ROOT_PATH = "/Users/xinzhilici/homebrew/var/www/n/clinical-cro"
                    } else if (env.BRANCH_NAME == 'test') {
                        env.NODE_ENV = "development"
                        env.APP_ENV = "test"
                        env.MOCK = "none"
                        env.BUILD_SH = "export NODE_ENV=${env.NODE_ENV} && export APP_ENV=${env.APP_ENV} && npx umi build"
                        env.ROOT_PATH = "/Users/xinzhilici/homebrew/var/www/n.test/clinical-cro"
                    } else if (env.BRANCH_NAME == 'dev') {
                        env.NODE_ENV = "development"
                        env.APP_ENV = "dev"
                        env.MOCK = "none"
                        env.BUILD_SH = "export NODE_ENV=${env.NODE_ENV} && export APP_ENV=${env.APP_ENV} && npx umi build"
                        env.ROOT_PATH = "/Users/xinzhilici/homebrew/var/www/n.dev/clinical-cro"
                    }
                    env.TARGET_HOST_IP = "172.16.10.126"
                }
            }
        }

        stage('checkout') {
            steps {
                git branch: "${BRANCH_NAME}",
                    credentialsId: "gitlab-ssh-key",
                    url: "git@git.xzlcorp.com:Web/clinical-cro.git"
                sh "ls -lat"
            }
        }

        stage('build') {
            steps {
                sh "export NODE_ENV=${env.NODE_ENV} && export APP_ENV=${env.APP_ENV} && npm install"
                sh "${BUILD_SH}"
            }
        }

        stage('deploy') {
            steps {
                script {
                if (env.BRANCH_NAME == 'master') {
                      sh 'AutoBuilder transfer  --rp ./clinical-cro --wp *'
                } else {
                    sshagent(credentials: ['jenkins-self-ssh-key']) {
                        sh 'ssh -o StrictHostKeyChecking=no -l xinzhilici ${TARGET_HOST_IP} "rm -rf ${ROOT_PATH} || true"'
                        sh 'ssh -o StrictHostKeyChecking=no -l xinzhilici ${TARGET_HOST_IP} "mkdir -p ${ROOT_PATH} || true"'
                        sh 'scp -o StrictHostKeyChecking=no -r ./clinical-cro/* xinzhilici@${TARGET_HOST_IP}:"${ROOT_PATH}"'
                    }
                }
              }
            }
        }
    }
}
